{"version":3,"sources":["pathdb_package.js"],"names":["PathDbMods","getCookie","key","cookiestring","RegExp","exec","document","cookie","decodeURIComponent","toString","replace","console","log","fetch","method","credentials","then","x","json","hasOwnProperty","token","warn","Store","prototype","default_findMark","findMark","slide","name","specimen","study","footprint","source","x0","x1","y0","y1","url","base","query","bySlide","objToParamStr","mode","errorHandler","filterBroken","getMarkByIds","ids","Array","isArray","hasError","message","suffix","stringifiedIds","map","id","join","findMarkTypes","default_findSlide","findSlide","location","headers","Headers","response","ok","error","text","statusText","default_getSlide","getSlide","default_findHeatmapType","findHeatmapType","StatesHelper","default_getCurrentStatesURL","getCurrentStatesURL","isImageCoordinate","states","getCurrentStates","encodeStates","origin","pathname","$D","params","slideId","CaMic","default_loadImg","loadImg","func","pathdb_id","URLSearchParams","window","search","get","slideName","store","data","field_study","length","value","field_study_id","field_specimen_id","specien","title","field_case_id","mpp","field_mpp_y","mpp_y","field_mpp_x","mpp_x","field_iip_path","viewer","open","createScalebar","OpenSeadragonImaging","ImagingHelper","setMaxZoom","call","Loading","textContent","catch","e"],"mappings":"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","file":"pathdb_package.js","sourceRoot":"../package","sourcesContent":["function PathDbMods() {\n  console.log(\"PathDbMods()...\");\n  // put the auth jwt in cookie as token\n  fetch(\"/jwt/token\", {\n    method: 'GET',\n    credentials: 'include'\n  }).then(x => x.json()).then(x => {\n    console.log(x)\n    if (x.hasOwnProperty('token') && x.token) {\n      document.cookie = \"token=\" + x.token + \";\"\n    }\n  })\n  /**\n  Gets a named cookie value\n  * @param {string} key - the key to get from the cookie\n  **/\n  function getCookie(key) {\n    var cookiestring = RegExp(\"\" + key + \"[^;]+\").exec(document.cookie);\n    return decodeURIComponent(!!cookiestring ? cookiestring.toString().replace(/^[^=]+./, \"\") : \"\");\n  }\n  console.warn(\"{PathDB mods enabled}\")\n  Store.prototype.default_findMark = Store.prototype.findMark\n  Store.prototype.findMark = function(slide, name, specimen, study, footprint, source, x0, x1, y0, y1) {\n    var suffix = \"Mark/find\"\n    var url = this.base + suffix;\n    var query = {}\n    var bySlideId\n    if (slide) {\n      query.slide = slide\n    }\n    if (name) {\n      query.name = name\n    }\n    if (specimen) {\n      query.specimen = specimen\n    }\n    if (study) {\n      query.study = study\n    }\n    if (footprint) {\n      query.footprint = footprint\n    }\n    if (source) {\n      query.source = source\n    }\n    if (x0) {\n      query.x0 = x0;\n    }\n    if (x1) {\n      query.x1 = x1;\n    }\n    if (y0) {\n      query.y0 = y0;\n    }\n    if (y1) {\n      query.y1 = y1;\n    }\n    let bySlide = fetch(url + \"?\" + objToParamStr(query), {\n      credentials: \"same-origin\",\n      mode: \"cors\"\n    }).then(this.errorHandler).then(x => this.filterBroken(x, \"mark\"))\n    return bySlide\n  }\n  Store.prototype.getMarkByIds = function(ids, slide, study, specimen, source, footprint, x0, x1, y0, y1) {\n    if (!Array.isArray(ids) || !slide) {\n      return {\n        hasError: true,\n        message: 'args are illegal'\n      }\n    }\n    var bySlideId\n    var suffix = \"Mark/multi\"\n    var url = this.base + suffix;\n    var query = {}\n    var stringifiedIds = ids.map(id => `\"${id}\"`).join(',');\n    query.name = `[${stringifiedIds}]`;\n    query.slide = slide;\n    if (study) {\n      query.study = study;\n    }\n    if (specimen) {\n      query.specimen = specimen;\n    }\n    if (source) {\n      query.source = source;\n    }\n    if (footprint) {\n      query.footprint = footprint;\n    }\n    if (x0) {\n      query.x0 = x0;\n    }\n    if (x1) {\n      query.x1 = x1;\n    }\n    if (y0) {\n      query.y0 = y0;\n    }\n    if (y1) {\n      query.y1 = y1;\n    }\n    let bySlide = fetch(url + \"?\" + objToParamStr(query), {\n      credentials: \"same-origin\",\n      mode: \"cors\"\n    }).then(this.errorHandler).then(x => this.filterBroken(x, \"mark\"))\n    return bySlide\n  }\n  Store.prototype.findMarkTypes = function(slide, name) {\n    var suffix = \"Mark/types\"\n    var url = this.base + suffix;\n    var query = {}\n    var bySlideId\n    if (name) {\n      query.name = name\n    }\n    if (slide) {\n      query.slide = slide\n    }\n    let bySlide = fetch(url + \"?\" + objToParamStr(query), {\n      credentials: \"same-origin\",\n      mode: \"cors\"\n    }).then(this.errorHandler)\n    return bySlide\n  }\n  Store.prototype.default_findSlide = Store.prototype.findSlide;\n  Store.prototype.findSlide = function(slide, specimen, study, location) {\n    var url = \"/node/\" + slide + \"?_format=json\"\n    return fetch(url, {\n      mode: \"cors\",\n      headers: new Headers({\n        'Authorization': 'Bearer ' + getCookie(\"token\"),\n      })\n    }).then(function(response) {\n      if (!response.ok) return {\n        error: !response.ok,\n        text: response.statusText,\n        url: response.url\n      };\n      return response.json().then(x => [x]);\n    })\n  }\n  Store.prototype.default_getSlide = Store.prototype.getSlide\n  Store.prototype.getSlide = function(id) {\n    var url = \"/node/\" + id + \"?_format=json\"\n    return fetch(url, {\n      mode: \"cors\",\n      headers: new Headers({\n        'Authorization': 'Bearer ' + getCookie(\"token\"),\n      })\n    }).then(function(response) {\n      if (!response.ok) return {\n        error: !response.ok,\n        text: response.statusText,\n        url: response.url\n      };\n      return response.json().then(x => [x]);\n    })\n  }\n\n\n  /**\n   * TEMPORARY!!\n   * TODO: When PathDB ready for heatmaps.\n   */\n  Store.prototype.default_findHeatmapType = Store.prototype.findHeatmapType;\n  findHeatmapType = function(slide, name) {\n    // uicallbacks gracefully handles case where array empty\n    return new Array(0);\n  };\n\n\n  StatesHelper.prototype.default_getCurrentStatesURL = StatesHelper.prototype.getCurrentStatesURL;\n  getCurrentStatesURL = function(isImageCoordinate=false){\n    let states = StatesHelper.getCurrentStates(isImageCoordinate);\n    if(!states)return;\n    console.log(states);\n    states = StatesHelper.encodeStates(states);\n    return `${location.origin}${location.pathname}?slideId=${$D.params.slideId}&states=${$D.params.states}&mode=${$D.params.mode}`\n  };\n\n\n  CaMic.prototype.default_loadImg = CaMic.prototype.loadImg\n  CaMic.prototype.loadImg = function(func) {\n    var urlParams = new URLSearchParams(window.location.search);\n    var pathdb_id = urlParams.get('slideId');\n    this.slideId = pathdb_id // default value\n    this.slideName = pathdb_id\n    this.study = \"\"\n    this.specimen = \"\"\n    this.store.getSlide(pathdb_id).then(data => {\n      data = data[0]\n      console.log(data)\n      // get slide metadata\n      if (data.field_study && data.field_study.length >=1){\n        this.study = data.field_study[0].value\n      }\n      if (data.field_study && data.field_study.length >=1){\n        this.study = data.field_study[0].value\n      }\n      if (data.field_study_id && data.field_study_id.length >=1){\n        this.study = data.field_study_id[0].value\n      }\n      if (data.field_specimen_id && data.field_specimen_id.length >=1){\n        this.specien = data.field_specimen_id[0].value\n      }\n      if (data.title && data.title.length >=1){\n        this.slideName = data.title[0].value\n        this.slideId = data.title[0].value\n      }\n      if (data.field_case_id && data.field_case_id.length >=1){\n        this.slideName = data.field_case_id[0].value\n        this.slideId = data.field_case_id[0].value\n      }\n      // set mpp\n      this.mpp = 1e9\n\n      if (data.field_mpp_y && data.field_mpp_y.length >= 1) {\n        this.mpp_y = data.field_mpp_y[0].value\n        this.mpp = this.mpp_y\n      }\n      if (data.field_mpp_x && data.field_mpp_x.length >= 1) {\n        this.mpp_x = data.field_mpp_x[0].value\n        this.mpp = this.mpp_x\n      }\n      if (data.field_iip_path && data.field_iip_path.length >= 1) {\n        this.location = data.field_iip_path[0].value\n        // MAKE URL FOR IIP\n        this.url = \"../../img/IIP/raw/?DeepZoom=\" + this.location + \".dzi\"\n        this.viewer.open(this.url);\n      } else {\n        throw \"No image location --could be token\"\n      }\n\n      this.viewer.mpp = this.mpp;\n      this.viewer.mpp_x = this.mpp_x;\n      this.viewer.mpp_y = this.mpp_y;\n\n      //set scalebar\n      if (this.mpp && this.mpp != 1e9) this.createScalebar(this.mpp)\n      var imagingHelper = new OpenSeadragonImaging.ImagingHelper({\n        viewer: this.viewer\n      });\n      imagingHelper.setMaxZoom(1);\n      // create item to pass to the callback function, previously x[0] (slide data)\n      let x = {}\n      x['_id'] = this.slideId\n      x.name = this.slideName\n      x.study = this.study\n      x.specimen = this.specimen\n      x.mpp = this.mpp;\n      x.mpp_x = this.mpp_x;\n      x.mpp_y = this.mpp_y;\n      x.location = this.location;\n      x.url = this.url;\n      if (func && typeof func === 'function') {\n        func.call(null, x);\n      }\n      Loading.text.textContent = `loading slide's tiles...`;\n      // we may want another init.js or our own callback\n    }).catch(e => {\n      console.error(e)\n      Loading.text.textContent = \"ERROR - PathDB Image Error (Try a refresh)\"\n      //if(func && typeof func === 'function') func.call(null,{hasError:true,message:e});\n    })\n\n  }\n}\n\n\nPathDbMods()\nconsole.warn(\"This setup is intended for pathdb\")\n"]}